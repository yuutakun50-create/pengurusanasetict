<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistem Pinjaman Aset ICT</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif; }
    .tab-active { border-bottom-width: 2px; border-color: #059669; color: #059669; }
    .tab-inactive { border-bottom-width: 2px; border-color: transparent; color: #4b5563; }
  </style>
</head>
<body class="bg-[#f3f5f7] min-h-screen">

  <!-- TOP BAR -->
  <header class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto flex items-center justify-between py-3 px-4">
      <div class="flex items-center gap-3">
        <!-- LOGO SKSA -->
        <img src="https://i.imgur.com/wpfWEN4.png" alt="Logo SK Sri Aman" class="w-10 h-10 rounded-full border" />
        <div>
          <h1 id="appTitle" class="font-bold text-lg text-gray-900">Sistem Pinjaman Aset ICT</h1>
          <p class="text-xs text-gray-500">SK Sri Aman</p>
        </div>
      </div>

      <button id="adminLoginBtn"
              class="flex items-center gap-2 text-sm px-5 py-2 border border-gray-200 rounded-full shadow-sm bg-white hover:bg-gray-50">
        <span>üîê</span><span id="adminLoginText">Log Masuk Admin</span>
      </button>
    </div>

    <!-- NAV TABS -->
    <nav class="border-t border-gray-100 bg-white">
      <div class="max-w-7xl mx-auto flex gap-6 px-4 text-sm">
        <button class="py-3 tab-active" data-page="permohonan">Permohonan</button>
        <button class="py-3 tab-inactive" data-page="aset-tersedia">Aset Tersedia</button>
        <button class="py-3 tab-inactive" data-page="aset-dipinjam">Aset Dipinjam</button>
        <button id="tabRekodPinjaman"
                class="py-3 tab-inactive hidden"
                data-page="rekod-pinjaman">
          Rekod Pinjaman
        </button>
      </div>
    </nav>
  </header>

  <!-- MAIN CONTENT -->
  <main class="max-w-7xl mx-auto py-8 px-4 space-y-8">

    <!-- ================= PERMOHONAN ================= -->
    <section id="page-permohonan" class="page-section">

      <!-- VIEW GURU (BUKAN ADMIN) -->
      <div id="permohonan-user-view"
           class="grid grid-cols-1 lg:grid-cols-[340px,minmax(0,1fr)] gap-6 items-start">
        <!-- FORM -->
        <div class="bg-white rounded-3xl shadow-xl border border-gray-100 p-6">
          <h2 class="font-semibold text-lg mb-1 text-gray-900">Borang Permohonan Pinjaman</h2>
          <p class="text-xs text-gray-400 mb-5">Isikan maklumat guru dan pilih aset di sebelah kanan.</p>

          <form id="loanForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1 text-gray-700">
                Nama Guru <span class="text-red-500">*</span>
              </label>
              <input type="text" id="namaGuru"
                     class="w-full rounded-full border border-gray-200 bg-gray-50 text-sm px-4 py-2.5
                            focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                     placeholder="Masukkan nama penuh" required />
            </div>

            <div>
              <label class="block text-sm font-medium mb-1 text-gray-700">
                No. Kad Pengenalan <span class="text-red-500">*</span>
              </label>
              <input type="text" id="noIC"
                     class="w-full rounded-full border border-gray-200 bg-gray-50 text-sm px-4 py-2.5
                            focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                     placeholder="cth: 900101-01-1234" required />
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1 text-gray-700">
                  Tarikh Pinjam <span class="text-red-500">*</span>
                </label>
                <input type="date" id="tarikhPinjam"
                       class="w-full rounded-full border border-gray-200 bg-gray-50 text-sm px-4 py-2.5
                              focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                       required />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1 text-gray-700">
                  Tarikh Pulang <span class="text-red-500">*</span>
                </label>
                <input type="date" id="tarikhPulang"
                       class="w-full rounded-full border border-gray-200 bg-gray-50 text-sm px-4 py-2.5
                              focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                       required />
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium mb-1 text-gray-700">
                Tujuan Pinjaman <span class="text-red-500">*</span>
              </label>
              <textarea id="tujuan"
                        class="w-full rounded-2xl border border-gray-200 bg-gray-50 text-sm px-4 py-3
                               focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                        rows="4"
                        placeholder="Nyatakan tujuan penggunaan aset" required></textarea>
            </div>

            <button type="submit"
                    class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold text-sm py-3 rounded-full shadow-md">
              Hantar Permohonan
            </button>
          </form>
        </div>

        <!-- PILIH ASET -->
        <div class="lg:col-span-1">
          <div class="bg-white rounded-3xl shadow-xl border border-gray-100 p-6">
            <div class="flex flex-wrap items-start justify-between gap-2 mb-4">
              <div>
                <h2 class="font-semibold text-lg text-gray-900">Pilih Aset</h2>
                <p class="text-xs text-gray-400 mt-1">
                  Pilih aset dan tetapkan bilangan unit yang diperlukan.
                </p>
              </div>
              <p class="text-[11px] text-gray-400">
                Tetapkan bilangan unit untuk setiap aset.
              </p>
            </div>
            <div id="assetChoiceList"
                 class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-5">
            </div>
          </div>
        </div>
      </div>

      <!-- VIEW ADMIN (PERMOHONAN MENUNGGU KELULUSAN) -->
      <div id="permohonan-admin-view" class="hidden">
        <div class="bg-white rounded-3xl shadow-xl border border-gray-100 p-6">
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-semibold text-lg text-gray-900">
              Permohonan Menunggu Kelulusan (Admin)
            </h2>
            <p id="pendingSummary" class="text-xs text-gray-500"></p>
          </div>
          <p class="text-xs text-gray-500 mb-4">
            Admin hanya meluluskan / menolak permohonan. Untuk meminjam aset, sila log keluar admin.
          </p>

          <div id="pendingRequestList" class="space-y-4"></div>
          <p id="noPendingRequests" class="text-sm text-gray-400 hidden">
            Tiada permohonan baharu buat masa ini.
          </p>
        </div>
      </div>
    </section>

    <!-- ================= ASET TERSEDIA ================= -->
    <section id="page-aset-tersedia" class="page-section hidden">
      <h2 class="font-semibold text-lg mb-4 text-gray-900">Aset Tersedia</h2>

      <!-- PANEL ADMIN: TAMBAH / EDIT ASET -->
      <div id="adminAssetPanel"
           class="mb-4 bg-white rounded-3xl shadow-xl border border-dashed border-emerald-400 p-4 hidden">
        <div class="flex justify-between items-center mb-3">
          <h3 id="adminAssetFormTitle" class="font-semibold text-sm">Tambah Aset Baharu</h3>
          <button type="button" id="resetAssetFormBtn" class="text-xs text-gray-500 hover:underline">
            Reset
          </button>
        </div>
        <p class="text-[11px] text-gray-500 mb-3">
          Hanya Admin: gunakan borang ini untuk tambah aset baharu atau edit aset sedia ada.
        </p>
        <form id="assetForm" class="grid md:grid-cols-2 gap-4 text-xs">
          <input type="hidden" id="assetIdField" />
          <div class="space-y-2">
            <div>
              <label class="block mb-1 font-medium">Nama Aset</label>
              <input id="assetName" type="text"
                     class="w-full border rounded-md px-2 py-1.5 bg-gray-50"
                     placeholder="cth: LAPTOP JOI CHROMEBOOK C100" />
            </div>
            <div>
              <label class="block mb-1 font-medium">Kategori</label>
              <input id="assetCategory" type="text"
                     class="w-full border rounded-md px-2 py-1.5 bg-gray-50"
                     placeholder="Laptop / Tablet / TV" />
            </div>
            <div>
              <label class="block mb-1 font-medium">URL Gambar</label>
              <input id="assetImageUrl" type="text"
                     class="w-full border rounded-md px-2 py-1.5 bg-gray-50"
                     placeholder="https://..." />
            </div>
          </div>
          <div class="space-y-2">
            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="block mb-1 font-medium">Jumlah Unit</label>
                <input id="assetTotal" type="number" min="0"
                       class="w-full border rounded-md px-2 py-1.5 bg-gray-50"
                       value="0" />
              </div>
              <div>
                <label class="block mb-1 font-medium">Unit Tersedia</label>
                <input id="assetAvailable" type="number" min="0"
                       class="w-full border rounded-md px-2 py-1.5 bg-gray-50"
                       value="0" />
              </div>
            </div>
            <div>
              <label class="block mb-1 font-medium">
                Spesifikasi
                <span class="font-normal text-gray-500">(1 baris 1 item, format: Label: Nilai)</span>
              </label>
              <textarea id="assetSpecs" rows="4"
                        class="w-full border rounded-md px-2 py-1.5 bg-gray-50"
                        placeholder="Pemproses: Intel i5&#10;RAM: 8GB&#10;Storan: 256GB SSD"></textarea>
            </div>
          </div>
          <div class="md:col-span-2 flex justify-end">
            <button type="submit"
                    class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-full text-xs font-semibold shadow">
              Simpan Aset
            </button>
          </div>
        </form>
      </div>

      <div id="assetAvailableList" class="grid md:grid-cols-2 xl:grid-cols-3 gap-5"></div>
    </section>

    <!-- ================= ASET DIPINJAM ================= -->
    <section id="page-aset-dipinjam" class="page-section hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="font-semibold text-lg text-gray-900">Aset Sedang Dipinjam</h2>
        <p id="summaryActiveLoans" class="text-xs text-gray-500"></p>
      </div>
      <div id="loanActiveList" class="space-y-4"></div>
      <p id="noActiveLoans" class="text-sm text-gray-500 hidden">Tiada aset sedang dipinjam.</p>
    </section>

    <!-- ================= REKOD PINJAMAN ================= -->
    <section id="page-rekod-pinjaman" class="page-section hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="font-semibold text-lg text-gray-900">Semua Rekod Pinjaman</h2>
        <div class="flex gap-2">
          <button onclick="window.print()"
                  class="flex items-center gap-2 text-xs px-3 py-2 border rounded-full bg-white shadow-sm hover:bg-gray-50">
            üñ® <span>Cetak Rekod</span>
          </button>
          <button id="clearRecordsBtn"
                  class="flex items-center gap-2 text-xs px-3 py-2 bg-red-600 text-white rounded-full shadow hover:bg-red-700">
            üóë <span>Kosongkan Rekod Lama</span>
          </button>
        </div>
      </div>

      <div class="overflow-x-auto bg-white rounded-3xl shadow-xl border border-gray-100">
        <table class="min-w-full text-xs">
          <thead class="bg-emerald-50 text-left">
            <tr>
              <th class="px-4 py-3 font-semibold">Nama Guru</th>
              <th class="px-4 py-3 font-semibold">No. IC</th>
              <th class="px-4 py-3 font-semibold">Aset Dipinjam</th>
              <th class="px-4 py-3 font-semibold">Tarikh</th>
              <th class="px-4 py-3 font-semibold">Tujuan</th>
              <th class="px-4 py-3 font-semibold">Status</th>
              <th class="px-4 py-3 font-semibold">Aksi</th>
            </tr>
          </thead>
          <tbody id="loanRecordTableBody" class="divide-y divide-gray-100"></tbody>
        </table>
      </div>
    </section>

  </main>

  <!-- FIREBASE & APP SCRIPT -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics-compat.js"></script>

  <script>
    // ================== FIREBASE CONFIG ==================
    const firebaseConfig = {
      apiKey: "AIzaSyCV5skKQO1i-T6pOckTEyhDG8H4fh7vS7s",
      authDomain: "sistem-pinjaman-aset-ict-v2.firebaseapp.com",
      databaseURL: "https://sistem-pinjaman-aset-ict-v2-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "sistem-pinjaman-aset-ict-v2",
      storageBucket: "sistem-pinjaman-aset-ict-v2.firebasestorage.app",
      messagingSenderId: "1013418266777",
      appId: "1:1013418266777:web:f3ec4d5f38fe7b87b76808",
      measurementId: "G-9CQDWM207Z"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ================== STATE & REFS ==================
    const assetsRef = db.ref("assets");
    const loansRef = db.ref("loans");

    let assetsCache = {};
    let loansCache = {};
    let selectedQuantities = {};
    let isAdmin = false;

    // DOM refs
    const assetChoiceListEl = document.getElementById("assetChoiceList");
    const assetAvailableListEl = document.getElementById("assetAvailableList");
    const loanActiveListEl = document.getElementById("loanActiveList");
    const noActiveLoansEl = document.getElementById("noActiveLoans");
    const summaryActiveLoansEl = document.getElementById("summaryActiveLoans");
    const loanRecordTableBodyEl = document.getElementById("loanRecordTableBody");
    const pendingRequestListEl = document.getElementById("pendingRequestList");
    const pendingSummaryEl = document.getElementById("pendingSummary");
    const noPendingRequestsEl = document.getElementById("noPendingRequests");
    const adminAssetPanelEl = document.getElementById("adminAssetPanel");
    const permohonanUserViewEl = document.getElementById("permohonan-user-view");
    const permohonanAdminViewEl = document.getElementById("permohonan-admin-view");

    const loanFormEl = document.getElementById("loanForm");

    // Admin asset form refs
    const assetForm = document.getElementById("assetForm");
    const assetIdField = document.getElementById("assetIdField");
    const assetNameField = document.getElementById("assetName");
    const assetCategoryField = document.getElementById("assetCategory");
    const assetImageField = document.getElementById("assetImageUrl");
    const assetTotalField = document.getElementById("assetTotal");
    const assetAvailableField = document.getElementById("assetAvailable");
    const assetSpecsField = document.getElementById("assetSpecs");
    const assetFormTitle = document.getElementById("adminAssetFormTitle");
    const assetFormResetBtn = document.getElementById("resetAssetFormBtn");
    let currentEditAssetId = null;

    // Seed aset default jika tiada
    const defaultAssets = {
      joi_chromebook_c100: {
        name: "LAPTOP JOI CHROMEBOOK C100",
        category: "Laptop",
        imageUrl: "https://via.placeholder.com/400x260?text=JOI+C100",
        total: 5,
        available: 5,
        specs: {
          "Pemproses": "MediaTek Kompanio 520",
          "RAM": "4GB LPDDR4X",
          "Storan": "64GB eMMC",
          "Skrin": "11.6 inci",
          "Resolusi": "1366 x 768 HD",
          "Kecerahan": "250 nits",
          "Sambungan": "Wi-Fi 6, Bluetooth 5.0",
          "Lain-lain": "ChromeOS"
        }
      },
      asus_vivobook_go15: {
        name: "LAPTOP ASUS VIVOBOOK GO 15",
        category: "Laptop",
        imageUrl: "https://via.placeholder.com/400x260?text=ASUS+GO+15",
        total: 5,
        available: 5,
        specs: {
          "Pemproses": "AMD Ryzen / Intel",
          "RAM": "8GB",
          "Storan": "256GB SSD",
          "Skrin": "15.6 inci",
          "Resolusi": "1920 x 1080",
          "Sambungan": "Wi-Fi, Bluetooth",
          "Lain-lain": "Windows 11"
        }
      },
      lenovo_k14_gen2: {
        name: "LAPTOP LENOVO K14 Gen 2",
        category: "Laptop",
        imageUrl: "https://via.placeholder.com/400x260?text=LENOVO+K14",
        total: 4,
        available: 4,
        specs: {
          "Pemproses": "Intel Core i5",
          "RAM": "8GB",
          "Storan": "256GB SSD",
          "Skrin": "14 inci",
          "Resolusi": "1920 x 1080",
          "Lain-lain": "Windows 11"
        }
      },
      lenovo_tab_m9: {
        name: "Lenovo Tab M9",
        category: "Tablet",
        imageUrl: "https://via.placeholder.com/400x260?text=Tab+M9",
        total: 34,
        available: 34,
        specs: {
          "Skrin": "9 inci",
          "Storan": "64GB",
          "RAM": "4GB",
          "Sistem": "Android"
        }
      },
      lg_tv_65: {
        name: 'SMART TV LG 65"',
        category: "TV",
        imageUrl: "https://via.placeholder.com/400x260?text=LG+65",
        total: 18,
        available: 18,
        specs: {
          "Skrin": '65"',
          "Resolusi": "4K UHD",
          "Sistem": "webOS",
          "Lain-lain": "Smart TV"
        }
      },
      joi_classmate_10: {
        name: "LAPTOP JOI CLASSMATE 10",
        category: "Laptop",
        imageUrl: "https://via.placeholder.com/400x260?text=Classmate+10",
        total: 5,
        available: 5,
        specs: {
          "Skrin": "10 inci",
          "Sistem": "Windows / ChromeOS"
        }
      }
    };

    assetsRef.once("value").then((snap) => {
      if (!snap.exists()) {
        assetsRef.set(defaultAssets);
      }
    });

    // ================== HELPERS ==================
    function textareaToSpecs(text) {
      const specs = {};
      text.split("\n").forEach(line => {
        const trimmed = line.trim();
        if (!trimmed) return;
        const parts = trimmed.split(":");
        const key = parts.shift();
        const value = parts.join(":").trim();
        if (key && value) specs[key.trim()] = value;
      });
      return specs;
    }

    function specsToTextarea(specsObj) {
      if (!specsObj) return "";
      return Object.entries(specsObj)
        .map(([k, v]) => `${k}: ${v}`)
        .join("\n");
    }

    function renderSpecRows(specsObj) {
      if (!specsObj) return '<span class="col-span-2 text-gray-400">Tiada spesifikasi direkodkan.</span>';
      return Object.entries(specsObj).map(([k, v]) => `
        <div class="text-gray-500">${k}</div>
        <div class="text-gray-800 font-medium">${v}</div>
      `).join("");
    }

    function formatDate(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr);
      if (Number.isNaN(d.getTime())) return dateStr;
      return d.toLocaleDateString("ms-MY");
    }

    // ================== TAB NAV ==================
    const tabButtons = document.querySelectorAll("[data-page]");
    const sections = {
      "permohonan": document.getElementById("page-permohonan"),
      "aset-tersedia": document.getElementById("page-aset-tersedia"),
      "aset-dipinjam": document.getElementById("page-aset-dipinjam"),
      "rekod-pinjaman": document.getElementById("page-rekod-pinjaman")
    };

    function showPage(pageKey) {
      for (const key in sections) {
        sections[key].classList.toggle("hidden", key !== pageKey);
      }
      tabButtons.forEach(btn => {
        const isActive = btn.dataset.page === pageKey;
        btn.classList.toggle("tab-active", isActive);
        btn.classList.toggle("tab-inactive", !isActive);
      });
    }

    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => showPage(btn.dataset.page));
    });

    // ================== RENDER ASET ==================
    function renderAssets() {
      if (!assetChoiceListEl || !assetAvailableListEl) return;

      assetChoiceListEl.innerHTML = "";
      assetAvailableListEl.innerHTML = "";

      Object.entries(assetsCache).forEach(([id, asset]) => {
        const available = asset.available ?? 0;
        const total = asset.total ?? available;
        const current = selectedQuantities[id] || 0;

        // Kad untuk pilih aset (guru)
        const cardChoice = document.createElement("div");
        cardChoice.className =
          "bg-white rounded-3xl shadow-md border border-gray-100 p-5 flex flex-col items-center text-center transition hover:shadow-xl";
        cardChoice.innerHTML = `
          <div class="w-full flex-1 flex flex-col items-center">
            <div class="w-full flex justify-center mb-4">
              <img src="${asset.imageUrl || 'https://via.placeholder.com/400x260?text=ASSET'}"
                   alt="${asset.name}"
                   class="h-32 object-contain drop-shadow-md" />
            </div>
            <p class="text-[11px] uppercase tracking-[0.25em] text-gray-400">
              ${asset.category || 'Aset'}
            </p>
            <h3 class="mt-1 font-semibold text-sm md:text-base text-gray-900">${asset.name}</h3>
            <p class="mt-1 text-[11px] text-gray-400">${available} daripada ${total} tersedia</p>
          </div>

          <div class="mt-4 flex items-center justify-center gap-2">
            <button type="button"
                    onclick="changeAssetQuantity('${id}', -1, ${available})"
                    class="w-8 h-8 flex items-center justify-center border border-gray-200 rounded-full bg-gray-50 hover:bg-gray-100">
              ‚àí
            </button>
            <input type="text"
                   id="qty-${id}"
                   value="${current}"
                   readonly
                   class="w-12 text-center text-sm border border-gray-200 rounded-full bg-gray-50" />
            <button type="button"
                    onclick="changeAssetQuantity('${id}', 1, ${available})"
                    class="w-8 h-8 flex items-center justify-center border border-gray-200 rounded-full bg-gray-50 hover:bg-gray-100">
              +
            </button>
            <span class="text-sm text-gray-600 ml-1">unit</span>
          </div>

          <button type="button"
                  onclick="toggleSpec('${id}-choice-spec')"
                  class="mt-3 text-[11px] text-emerald-600 hover:text-emerald-700 flex items-center gap-1">
            <span>Spesifikasi</span><span>‚ñæ</span>
          </button>

          <div id="${id}-choice-spec"
               class="hidden mt-2 w-full bg-gray-50 rounded-2xl border border-gray-100 text-[11px] px-4 py-3 text-left grid grid-cols-2 gap-y-1">
            ${renderSpecRows(asset.specs)}
          </div>
        `;
        assetChoiceListEl.appendChild(cardChoice);

        // Kad untuk Aset Tersedia
        const cardAvail = document.createElement("div");
        cardAvail.className =
          "bg-white rounded-3xl shadow-md border border-gray-100 p-5 flex flex-col transition hover:shadow-xl";
        cardAvail.innerHTML = `
          <div class="flex gap-4">
            <div class="flex-shrink-0">
              <img src="${asset.imageUrl || 'https://via.placeholder.com/400x260?text=ASSET'}"
                   alt="${asset.name}"
                   class="w-24 h-24 object-contain rounded-2xl bg-gray-50" />
            </div>
            <div class="flex-1">
              <div class="flex justify-between items-start gap-2">
                <div>
                  <p class="text-[11px] uppercase tracking-[0.25em] text-gray-400">
                    ${asset.category || 'Aset'}
                  </p>
                  <h3 class="font-semibold text-sm md:text-base text-gray-900">${asset.name}</h3>
                  <p class="text-[11px] text-gray-400 mt-1">
                    ${available} daripada ${total} tersedia
                  </p>
                </div>
                <div class="bg-emerald-500 text-white text-xs font-semibold px-3 py-1 rounded-full self-start shadow-sm">
                  ${available}
                </div>
              </div>
            </div>
          </div>

          <button type="button"
                  onclick="toggleSpec('${id}-avail-spec')"
                  class="mt-3 text-[11px] text-emerald-600 hover:text-emerald-700 flex items-center gap-1">
            <span>Spesifikasi</span><span>‚ñæ</span>
          </button>

          <div id="${id}-avail-spec"
               class="hidden mt-2 bg-gray-50 rounded-2xl border border-gray-100 text-[11px] px-4 py-3 grid grid-cols-2 gap-y-1">
            ${renderSpecRows(asset.specs)}
          </div>

          ${isAdmin ? `
          <div class="mt-4 flex justify-end gap-2">
            <button type="button"
                    onclick="startEditAsset('${id}')"
                    class="px-3 py-1.5 text-[11px] border border-gray-200 rounded-full bg-white hover:bg-gray-50">
              Edit
            </button>
            <button type="button"
                    onclick="deleteAsset('${id}')"
                    class="px-3 py-1.5 text-[11px] bg-red-600 text-white rounded-full hover:bg-red-700">
              Padam
            </button>
          </div>
          ` : ``}
        `;
        assetAvailableListEl.appendChild(cardAvail);
      });
    }

    function changeAssetQuantity(id, delta, maxAvailable) {
      const oldVal = selectedQuantities[id] || 0;
      let newVal = oldVal + delta;
      if (newVal < 0) newVal = 0;
      if (newVal > maxAvailable) newVal = maxAvailable;
      selectedQuantities[id] = newVal;
      const input = document.getElementById("qty-" + id);
      if (input) input.value = newVal;
    }
    window.changeAssetQuantity = changeAssetQuantity;

    function toggleSpec(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.toggle("hidden");
    }
    window.toggleSpec = toggleSpec;

    // ================== RENDER LOANS ==================
    function renderLoans() {
      if (!loanActiveListEl || !loanRecordTableBodyEl) return;

      loanActiveListEl.innerHTML = "";
      loanRecordTableBodyEl.innerHTML = "";
      if (pendingRequestListEl) pendingRequestListEl.innerHTML = "";

      let activeCount = 0;
      let pendingCount = 0;

      const now = new Date();

      Object.entries(loansCache).forEach(([id, loan]) => {
        const end = new Date(loan.endDate);
        const msDiff = end - now;
        const daysLeft = Math.ceil(msDiff / (1000 * 60 * 60 * 24));

        const itemListText = Object.values(loan.items || {})
          .map(i => `${i.quantity} x ${i.name}`)
          .join(", ");

        // PENDING - hanya untuk admin view
        if (loan.status === "Menunggu Kelulusan" && !loan.isReturned) {
          pendingCount++;
          if (pendingRequestListEl) {
            const card = document.createElement("div");
            card.className = "bg-white rounded-3xl shadow-md border border-gray-100 p-5";
            card.innerHTML = `
              <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-2 text-sm font-semibold text-gray-800">
                  <span>üë§</span><span>${loan.guruName}</span>
                </div>
                <span class="text-[11px] px-3 py-1 rounded-full bg-yellow-100 text-yellow-800 font-semibold">
                  Menunggu Kelulusan
                </span>
              </div>

              <div class="text-xs text-gray-700 space-y-1 mb-3">
                <div class="flex justify-between gap-2">
                  <span class="font-semibold">Aset Dipohon</span>
                  <span class="text-right">${itemListText}</span>
                </div>
                <div class="flex justify-between gap-2">
                  <span class="font-semibold">Tarikh</span>
                  <span class="text-right">${formatDate(loan.startDate)} - ${formatDate(loan.endDate)}</span>
                </div>
                <div class="flex justify-between gap-2">
                  <span class="font-semibold">Tujuan</span>
                  <span class="text-right">${loan.purpose}</span>
                </div>
              </div>

              <div class="flex gap-2">
                <button type="button"
                        onclick="approveLoan('${id}')"
                        class="text-xs bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-full shadow">
                  Luluskan
                </button>
                <button type="button"
                        onclick="rejectLoan('${id}')"
                        class="text-xs bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-full shadow">
                  Tolak
                </button>
              </div>
            `;
            pendingRequestListEl.appendChild(card);
          }
        }

        // ACTIVE (Diluluskan & belum dipulangkan)
        if (loan.status === "Diluluskan" && !loan.isReturned) {
          activeCount++;

          const card = document.createElement("div");
          card.className =
            "bg-white rounded-3xl shadow-md border border-gray-100 p-5";
          card.innerHTML = `
            <div class="flex justify-between items-center mb-3">
              <div class="flex items-center gap-2 text-sm font-semibold text-gray-800">
                <span>üë§</span><span>${loan.guruName}</span>
              </div>
              <span class="text-[11px] px-3 py-1 rounded-full bg-emerald-500 text-white font-semibold shadow-sm">
                Diluluskan
              </span>
            </div>

            <div class="bg-emerald-50 rounded-2xl px-4 py-3 mb-3 flex items-center gap-3">
              <span class="text-xl">‚è∞</span>
              <div>
                <p class="text-[11px] uppercase tracking-wide text-gray-600">Masa Pinjaman</p>
                <p class="text-lg font-bold text-emerald-700">
                  ${daysLeft >= 0 ? `${daysLeft} HARI LAGI` : "TAMAT TEMPOH"}
                </p>
              </div>
            </div>

            <div class="text-xs text-gray-700 space-y-1 mb-3">
              <div class="flex justify-between gap-2">
                <span class="font-semibold">Aset Dipinjam</span>
                <span class="text-right">${itemListText}</span>
              </div>
              <div class="flex justify-between gap-2">
                <span class="font-semibold">Tarikh</span>
                <span class="text-right">${formatDate(loan.startDate)} - ${formatDate(loan.endDate)}</span>
              </div>
              <div class="flex justify-between gap-2">
                <span class="font-semibold">Tujuan</span>
                <span class="text-right">${loan.purpose}</span>
              </div>
            </div>

            <button type="button"
                    onclick="markReturned('${id}')"
                    class="text-xs bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 rounded-full shadow">
              Tandakan Pulang
            </button>
          `;
          loanActiveListEl.appendChild(card);
        }

        // Rekod Pinjaman (semua status)
        let statusClass = "bg-gray-100 text-gray-700";
        let statusLabel = loan.status || "Tidak Diketahui";
        if (loan.status === "Menunggu Kelulusan") {
          statusClass = "bg-yellow-100 text-yellow-800";
        } else if (loan.status === "Diluluskan" && !loan.isReturned) {
          statusClass = "bg-emerald-100 text-emerald-700";
        } else if (loan.status === "Ditolak") {
          statusClass = "bg-red-100 text-red-700";
        } else if (loan.status === "Dipulangkan" || loan.isReturned) {
          statusClass = "bg-gray-200 text-gray-700";
          statusLabel = "Dipulangkan";
        }

        let actionHtml = "";
        if (loan.status === "Menunggu Kelulusan" && !loan.isReturned) {
          actionHtml = `
            <button type="button"
                    onclick="approveLoan('${id}')"
                    class="text-[10px] bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 rounded-full mr-1">
              Lulus
            </button>
            <button type="button"
                    onclick="rejectLoan('${id}')"
                    class="text-[10px] bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-full">
              Tolak
            </button>
          `;
        } else if (loan.status === "Diluluskan" && !loan.isReturned) {
          actionHtml = `
            <button type="button"
                    onclick="markReturned('${id}')"
                    class="text-[10px] bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 rounded-full">
              Pulang
            </button>
          `;
        } else {
          actionHtml = '<span class="text-gray-400 text-[10px]">Tiada Aksi</span>';
        }

        const tr = document.createElement("tr");
        tr.className = "hover:bg-gray-50 text-[11px]";
        tr.innerHTML = `
          <td class="px-4 py-3 whitespace-nowrap">${loan.guruName}</td>
          <td class="px-4 py-3 whitespace-nowrap">${loan.ic}</td>
          <td class="px-4 py-3 whitespace-nowrap">
            ${Object.values(loan.items || {}).map(i => `${i.quantity} x ${i.name}`).join("<br>")}
          </td>
          <td class="px-4 py-3 whitespace-nowrap">
            ${formatDate(loan.startDate)} - ${formatDate(loan.endDate)}
          </td>
          <td class="px-4 py-3 whitespace-nowrap">${loan.purpose}</td>
          <td class="px-4 py-3 whitespace-nowrap">
            <span class="inline-flex px-2 py-1 rounded-full text-[10px] font-semibold ${statusClass}">
              ${statusLabel}
            </span>
          </td>
          <td class="px-4 py-3 whitespace-nowrap">
            ${actionHtml}
          </td>
        `;
        loanRecordTableBodyEl.appendChild(tr);
      });

      // ringkasan
      if (summaryActiveLoansEl) {
        summaryActiveLoansEl.textContent = activeCount
          ? `${activeCount} pinjaman aktif`
          : "";
      }
      if (noActiveLoansEl) {
        noActiveLoansEl.classList.toggle("hidden", activeCount > 0);
      }
      if (pendingSummaryEl) {
        pendingSummaryEl.textContent = pendingCount
          ? `${pendingCount} permohonan menunggu kelulusan`
          : "";
      }
      if (noPendingRequestsEl) {
        noPendingRequestsEl.classList.toggle("hidden", pendingCount > 0);
      }
    }

    // ================== LOAN ACTIONS ==================
    function markReturned(loanId) {
      const loan = loansCache[loanId];
      if (!loan) return;
      if (loan.status !== "Diluluskan" || loan.isReturned) {
        alert("Pinjaman ini belum diluluskan atau sudah dipulangkan.");
        return;
      }
      if (!confirm("Tandakan semua aset dalam pinjaman ini telah dipulangkan?")) return;

      const updates = {};

      Object.entries(loan.items || {}).forEach(([id, item]) => {
        const asset = assetsCache[id];
        if (!asset) return;
        const available = asset.available ?? 0;
        updates["assets/" + id + "/available"] = available + item.quantity;
      });

      updates["loans/" + loanId + "/isReturned"] = true;
      updates["loans/" + loanId + "/status"] = "Dipulangkan";
      updates["loans/" + loanId + "/returnedAt"] = new Date().toISOString();

      db.ref().update(updates).catch(console.error);
    }
    window.markReturned = markReturned;

    function approveLoan(loanId) {
      if (!isAdmin) {
        alert("Hanya admin boleh meluluskan permohonan.");
        return;
      }
      const loan = loansCache[loanId];
      if (!loan) return;
      if (loan.status !== "Menunggu Kelulusan") {
        alert("Permohonan ini sudah diproses.");
        return;
      }

      // Semak stok mencukupi
      for (const [id, item] of Object.entries(loan.items || {})) {
        const asset = assetsCache[id];
        if (!asset) {
          alert(`Aset "${item.name}" tidak wujud dalam senarai.`);
          return;
        }
        const available = asset.available ?? 0;
        if (item.quantity > available) {
          alert(`Stok tidak mencukupi untuk "${asset.name}". Tersedia: ${available} unit.`);
          return;
        }
      }

      if (!confirm("Luluskan permohonan ini? Stok akan ditolak.")) return;

      const updates = {};
      Object.entries(loan.items || {}).forEach(([id, item]) => {
        const asset = assetsCache[id];
        const available = asset.available ?? 0;
        updates["assets/" + id + "/available"] = available - item.quantity;
      });
      updates["loans/" + loanId + "/status"] = "Diluluskan";
      updates["loans/" + loanId + "/approvedAt"] = new Date().toISOString();

      db.ref().update(updates).catch(console.error);
    }
    window.approveLoan = approveLoan;

    function rejectLoan(loanId) {
      if (!isAdmin) {
        alert("Hanya admin boleh menolak permohonan.");
        return;
      }
      const loan = loansCache[loanId];
      if (!loan) return;
      if (loan.status !== "Menunggu Kelulusan") {
        alert("Permohonan ini sudah diproses.");
        return;
      }
      if (!confirm("Tolak permohonan ini?")) return;

      const updates = {};
      updates["loans/" + loanId + "/status"] = "Ditolak";
      updates["loans/" + loanId + "/rejectedAt"] = new Date().toISOString();
      db.ref().update(updates).catch(console.error);
    }
    window.rejectLoan = rejectLoan;

    // ================== LISTENERS FIREBASE ==================
    assetsRef.on("value", (snap) => {
      assetsCache = snap.val() || {};
      renderAssets();
    });

    loansRef.on("value", (snap) => {
      loansCache = snap.val() || {};
      renderLoans();
    });

    // ================== HANTAR PERMOHONAN (GURU) ==================
    loanFormEl.addEventListener("submit", function (e) {
      e.preventDefault();

      if (isAdmin) {
        alert("Admin tidak boleh menghantar permohonan. Sila log keluar admin jika mahu meminjam.");
        return;
      }

      const namaGuru = document.getElementById("namaGuru").value.trim();
      const noIC = document.getElementById("noIC").value.trim();
      const tarikhPinjam = document.getElementById("tarikhPinjam").value;
      const tarikhPulang = document.getElementById("tarikhPulang").value;
      const tujuan = document.getElementById("tujuan").value.trim();

      const selectedItems = {};
      let totalUnit = 0;

      Object.entries(selectedQuantities).forEach(([id, qty]) => {
        if (qty > 0 && assetsCache[id]) {
          selectedItems[id] = {
            name: assetsCache[id].name,
            quantity: qty
          };
          totalUnit += qty;
        }
      });

      if (!totalUnit) {
        alert("Sila pilih sekurang-kurangnya satu aset untuk dipinjam.");
        return;
      }
      if (!namaGuru || !noIC || !tarikhPinjam || !tarikhPulang || !tujuan) {
        alert("Sila lengkapkan semua maklumat borang.");
        return;
      }
      if (tarikhPulang < tarikhPinjam) {
        alert("Tarikh pulang tidak boleh lebih awal daripada tarikh pinjam.");
        return;
      }

      if (!confirm("Hantar permohonan pinjaman aset untuk kelulusan admin?")) return;

      const newLoanRef = loansRef.push();
      const loanId = newLoanRef.key;

      const loanData = {
        id: loanId,
        guruName: namaGuru,
        ic: noIC,
        startDate: tarikhPinjam,
        endDate: tarikhPulang,
        purpose: tujuan,
        items: selectedItems,
        status: "Menunggu Kelulusan",
        isReturned: false,
        createdAt: new Date().toISOString()
      };

      newLoanRef.set(loanData)
        .then(() => {
          alert("Permohonan dihantar. Sila tunggu kelulusan admin.");
          loanFormEl.reset();
          selectedQuantities = {};
          renderAssets();
        })
        .catch((err) => {
          console.error(err);
          alert("Ralat semasa menyimpan permohonan. Sila cuba lagi.");
        });
    });

    // ================== CLEAR REKOD DIPULANGKAN ==================
    document.getElementById("clearRecordsBtn").addEventListener("click", () => {
      if (!confirm("Padam semua rekod yang telah dipulangkan?")) return;
      const updates = {};
      Object.entries(loansCache).forEach(([id, loan]) => {
        if (loan.isReturned) updates["loans/" + id] = null;
      });
      if (Object.keys(updates).length === 0) {
        alert("Tiada rekod dipulangkan untuk dipadam.");
        return;
      }
      db.ref().update(updates).then(() => {
        alert("Rekod lama berjaya dikosongkan.");
      }).catch(console.error);
    });

    // ================== ADMIN: ASSET FORM ==================
    function resetAssetForm() {
      if (!assetForm) return;
      currentEditAssetId = null;
      assetForm.reset();
      assetIdField.value = "";
      assetFormTitle.textContent = "Tambah Aset Baharu";
    }

    if (assetForm) {
      assetForm.addEventListener("submit", function (e) {
        e.preventDefault();
        if (!isAdmin) {
          alert("Hanya admin boleh menyimpan aset.");
          return;
        }

        const name = assetNameField.value.trim();
        const category = assetCategoryField.value.trim() || "Aset";
        const imageUrl = assetImageField.value.trim();
        let total = parseInt(assetTotalField.value, 10);
        let available = parseInt(assetAvailableField.value, 10);

        if (!name) {
          alert("Sila isi nama aset.");
          return;
        }
        if (isNaN(total) || total < 0) total = 0;
        if (isNaN(available) || available < 0) available = 0;
        if (available > total) available = total;

        const specs = textareaToSpecs(assetSpecsField.value);

        const assetData = { name, category, imageUrl, total, available, specs };
        const existingId = assetIdField.value;

        if (!existingId) {
          const newRef = assetsRef.push();
          newRef.set(assetData)
            .then(() => {
              alert("Aset baharu disimpan.");
              resetAssetForm();
            })
            .catch(err => {
              console.error(err);
              alert("Ralat menyimpan aset baharu.");
            });
        } else {
          assetsRef.child(existingId).update(assetData)
            .then(() => {
              alert("Aset dikemas kini.");
              resetAssetForm();
            })
            .catch(err => {
              console.error(err);
              alert("Ralat mengemas kini aset.");
            });
        }
      });

      assetFormResetBtn.addEventListener("click", resetAssetForm);
    }

    function startEditAsset(id) {
      if (!isAdmin) {
        alert("Hanya admin boleh edit aset.");
        return;
      }
      const asset = assetsCache[id];
      if (!asset || !assetForm) return;

      showPage("aset-tersedia");
      currentEditAssetId = id;
      assetIdField.value = id;
      assetNameField.value = asset.name || "";
      assetCategoryField.value = asset.category || "";
      assetImageField.value = asset.imageUrl || "";
      assetTotalField.value = asset.total ?? 0;
      assetAvailableField.value = asset.available ?? 0;
      assetSpecsField.value = specsToTextarea(asset.specs);
      assetFormTitle.textContent = "Edit Aset";

      if (adminAssetPanelEl) adminAssetPanelEl.scrollIntoView({ behavior: "smooth" });
    }
    window.startEditAsset = startEditAsset;

    function deleteAsset(id) {
      if (!isAdmin) {
        alert("Hanya admin boleh padam aset.");
        return;
      }
      const asset = assetsCache[id];
      const name = asset?.name || id;
      if (!confirm(`Padam aset "${name}"?`)) return;

      assetsRef.child(id).remove()
        .catch(err => {
          console.error(err);
          alert("Ralat memadam aset.");
        });
    }
    window.deleteAsset = deleteAsset;

    function updateAdminUI() {
      if (adminAssetPanelEl) {
        adminAssetPanelEl.classList.toggle("hidden", !isAdmin);
      }
      if (permohonanUserViewEl && permohonanAdminViewEl) {
        permohonanUserViewEl.classList.toggle("hidden", isAdmin);
        permohonanAdminViewEl.classList.toggle("hidden", !isAdmin);
      }
      renderAssets();
      renderLoans();
    }

    // ================== ADMIN LOGIN ==================
    const adminLoginBtn = document.getElementById("adminLoginBtn");
    const adminLoginText = document.getElementById("adminLoginText");
    const tabRekodPinjaman = document.getElementById("tabRekodPinjaman");
    const appTitle = document.getElementById("appTitle");

    adminLoginBtn.addEventListener("click", () => {
      if (!isAdmin) {
        const pwd = prompt("Masukkan kata laluan admin:");
        if (pwd === "admin123") {
          isAdmin = true;
          adminLoginText.textContent = "Log Keluar";
          tabRekodPinjaman.classList.remove("hidden");
          appTitle.textContent = "Dashboard Admin ¬∑ Sistem Pinjaman Aset ICT";
          alert("Selamat datang, Admin.");
          updateAdminUI();
        } else if (pwd !== null) {
          alert("Kata laluan salah.");
        }
      } else {
        isAdmin = false;
        adminLoginText.textContent = "Log Masuk Admin";
        tabRekodPinjaman.classList.add("hidden");
        appTitle.textContent = "Sistem Pinjaman Aset ICT";
        resetAssetForm();
        updateAdminUI();
        showPage("permohonan");
      }
    });

    // ================== INIT ==================
    showPage("permohonan");
  </script>
</body>
</html>
